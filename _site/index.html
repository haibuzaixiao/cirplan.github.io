
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>首页</title>
    
    <meta name="author" content="dcirplan">

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Le fav and touch icons -->
    <link rel="shortcut icon" href="/favicon.ico">
    <!-- Bootstrap styles -->
    <link href="/assets/themes/bootstrap-3/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <!-- Optional theme -->
    <link href="/assets/themes/bootstrap-3/bootstrap/css/bootstrap-theme.min.css" rel="stylesheet">
    <!-- Sticky Footer -->
    <link href="/assets/themes/bootstrap-3/bootstrap/css/bs-sticky-footer.css" rel="stylesheet">
    <!-- prettify -->
    <link href="/assets/themes/bootstrap-3/bootstrap/css/prettify_github.css" rel="stylesheet" >
    <!-- Custom styles -->
    <link href="/assets/themes/bootstrap-3/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <!-- Update these with your own images
      <link rel="shortcut icon" href="images/favicon.ico">
      <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
      <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
      <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
    -->

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">

  </head>

  <body>
    <div id="wrap">
      <nav class="navbar navbar-default" role="navigation">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="container">
          <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#jb-navbar-collapse">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">萝拔</a>
          </div>

          <!-- Collect the nav links, forms, and other content for toggling -->
          <div class="collapse navbar-collapse" id="jb-navbar-collapse">
            <ul class="nav navbar-nav">
              
              
              


  
    
      
      	
      	<li><a href="/archive.html">归档</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/categories.html">分类</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/pages.html">页面</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags.html">标签</a></li>
      	
      
    
  



            </ul>
           
          </div><!-- /.navbar-collapse -->
        </div>
      </nav>

      <div class="container">
        


<div class="row post">
  <div class="span11">
    <h1 class="title">
      <a href="/js/2015/07/06/canvas-resolution" title="canvas分辨率问题">canvas分辨率问题</a> 
      
    </h1>
    <div class="date f-c-b">Date：<span>2015-07-06</span></div>
    
    <div class="tag-n">
      <span class="tag-tip">Tag:</span>
      <ul class="tag_box">
      
      


  
     
    	<li><a href="/tags.html#js-ref">js <span>1</span></a></li>
     
    	<li><a href="/tags.html#canvas-ref">canvas <span>1</span></a></li>
    
  



      </ul>
     
      </div>
      
<p>过程：最近尝试用H5的canvas写了个小游戏，然后加载图片的时候发现，在电脑上图片是很清晰的，但到了手机上就看到比较模糊（图片都是实际大小的2倍）。</p>

<p>再现：demo代码如下</p>

<pre><code>window.onload = function () {
	var canvas = document.getElementById('canvas1');
	var ctx = canvas.getContext("2d");
	var width, height;
	width = 320;
	height = 568;

	canvas.style.width = width+'px';
	canvas.style.height = height + 'px';
	canvas.width = width; 
	canvas.height = height;
	var img = new Image();
	img.src = "../img/s6_1.png";
	img.onload = function () {  
	    ctx.drawImage(img, 20, 20, img.width/2, img.height/2); 
	}  
}();
</code></pre>

<p>先看效果图（左边为电脑模拟，右边为手机）：</p>

<p><img src="/images/2015/20150706canvas/1_pc.png" alt="电脑" />
<img src="/images/2015/20150706canvas/2_phone.jpg" alt="手机" /></p>

<p>有没有发现什么？认真看就会发现：右边的图比较模糊（如果实在没发现请自戳双目，为什么？因为留着没用）。</p>

<p>所以现在问题是：<code>为什么canvas加载图片在手机上会显示模糊？</code></p>

<p>首先我们看看上面的代码：</p>

<pre><code>canvas.style.width = width+'px';
canvas.style.height = height + 'px';
canvas.width = width; 
canvas.height = height;
</code></pre>

<p>这样子写是不是有点多此一举了？闲的蛋疼？为了证明不是蛋疼，首先我们要了解<code>设备像素</code>和<code>CSS像素</code>。</p>

<h3 id="css">设备像素和CSS像素</h3>

<p>设备像素就是我们平时所说的设备真实像素，像iPhone5s的 640 x 1136。但一般开发者是不怎么关心这个数值的，因为有CSS像素。</p>

<p>CSS像素是我们平时代码直接用的，iPhone5s的CSS像素为 320 x 568（这样子应该懂了吧）。</p>

<p>由于设备像素和CSS像素不一样，所以设备会用几个设备像素表示一个CSS像素。像iPhone5s就是4个设备像素点表示一个CSS像素。如图：</p>

<p><img src="/images/2015/20150706canvas/3_px.gif" alt="像素比例" /></p>

<p>这里就有一个很常见的问题：为什么图片在retina屏中会模糊？</p>

<p>例如要显示 100px x 100px 的图片，如果切出来的图片也是 100px x 100px，那么在iPhone5s下是肯定会模糊的。
因为iPhone5s的 设备像素/CSS像素 比是2。所以它需要的图片实际大小为 200px x 200px。如果像现在这样大小不够呢？那像素点只能被扩充了。</p>

<p>什么是扩充？就是5s的4个设备像素点表示1个CSS像素点时候，本应该4个像素点都有各自的颜色的，但图片小了，那4个设备像素点都是复制成同一种颜色。十分简单粗暴的方法。</p>

<p><code>canvas的显示也是类似于图片，如果不够大就会被扩充。</code></p>

<p><code>canvas.width/height</code> 表示的是设备像素，而 <code>canvas.style.width/height</code> 表示的是CSS像素。所以设置<code>canvas.width/height==canvas.style.width/height</code>的时候，如果 设备像素/CSS像素 不是1，canvas就被扩充了，然后图片加载进去，虽然是2倍实际大小，但还是模糊掉了（这里没想通？再想想）。这样就很好解析刚刚的例子在电脑端没有模糊（我的电脑像素比是1），但在手机端却模糊了（还不明白？不是我的问题就是你的问题了）。</p>

<h3 id="section">解决方法</h3>

<p>既然问题出现了，总是会有解决方法的。先看两个参数 <code>devicePixelRatio</code>和<code>webkitBackingStorePixelRatio</code>。</p>

<h4 id="devicepixelratio">devicePixelRatio</h4>

<p>devicePixelRatio是window下的属性，是 设备像素/CSS像素 的比值。下面列出了一些：</p>

<ul>
  <li>iPhone5s 		2</li>
  <li>iPhone6 plus  3</li>
  <li>nexus7 		1.3 (非常奇葩)</li>
</ul>

<p>这个参数比较简单直观，不用多说。其实在chrome模拟手机浏览的时候，也有这个参数的，如图：</p>

<p><img src="/images/2015/20150706canvas/4_pc_px.png" alt="chrome模拟像素比" /></p>

<p>上图中红色框中的就是这个像素比。</p>

<h4 id="webkitbackingstorepixelratio">webkitBackingStorePixelRatio</h4>

<p>webkitBackingStorePixelRatio是存在canvas context中（仅safari和chrome），该属性的值决定了浏览器在渲染canvas之前会用几个像素来存储画布信息。
例如，在iOS6 safari中这个值为2，它要渲染 100px x 100px 的图片，首先会在内存中生成一张200x200的图片，然后浏览器渲染的时候，会按100x100的图片来渲染，
因此就变成了200x200，正好和内存中的图片大小一致，因此在iOS的safari中不会出现失真的问题（有点绕口，慢慢理解）。</p>

<p>但是在iOS7 的safari中这个值又变成了1，是出于性能的考虑，详情可以看<a href="http://asciiwwdc.com/2013/sessions/600">这里</a>，搜索关键字‘backing’。</p>

<p>知道了这俩个参数，那接下来怎么玩？实践是检验真理的唯一标准。</p>

<h3 id="section-1">实践</h3>

<p>修改之前的代码，把像素比加进去：</p>

<pre><code>var PIXEL_RATIO = (function () {
    var ctx = document.createElement("canvas").getContext("2d"),
        dpr = window.devicePixelRatio || 1,
        bsr = ctx.webkitBackingStorePixelRatio ||
              ctx.mozBackingStorePixelRatio ||
              ctx.msBackingStorePixelRatio ||
              ctx.oBackingStorePixelRatio ||
              ctx.backingStorePixelRatio || 1;

    return dpr / bsr;
})();

window.onload = function () {
	var canvas = document.getElementById('canvas1');
	var ctx = canvas.getContext("2d");
	var width, height;
	width = 320;
	height = 568;

	canvas.style.width = width+'px';
	canvas.style.height = height + 'px';
	canvas.width = width * PIXEL_RATIO; 
	canvas.height = height * PIXEL_RATIO;
	var img = new Image();
	img.src = "../img/s6_1.png";
	img.onload = function () {  
	    ctx.drawImage(img, 20, 20, img.width/2, img.height/2); 
	}  
}();
</code></pre>

<p>看看效果（左边为之前效果，右边为修改后效果）：</p>

<p><img src="/images/2015/20150706canvas/1_pc.png" alt="之前" />
<img src="/images/2015/20150706canvas/5_pc.png" alt="之后" /></p>

<p>发现了什么？图居然缩小了！我滴天，这是为什么？认真想想问题出在哪里。</p>

<p><code>因为CSS像素点被缩放了</code>，为什么会缩放？因为它是大爷，它想缩所以缩了。</p>

<p>所以解决方案是对canvas进行缩放，下面是完整版代码：</p>

<pre><code>var PIXEL_RATIO = (function () {
	    var ctx = document.createElement("canvas").getContext("2d"),
	        dpr = window.devicePixelRatio || 1,
	        bsr = ctx.webkitBackingStorePixelRatio ||
	              ctx.mozBackingStorePixelRatio ||
	              ctx.msBackingStorePixelRatio ||
	              ctx.oBackingStorePixelRatio ||
	              ctx.backingStorePixelRatio || 1;

	    return dpr / bsr;
})();

window.onload = function () {
	var canvas = document.getElementById('canvas1');
	var ctx = canvas.getContext("2d");
	var width, height;
	width = 320;
	height = 568;

	canvas.style.width = width+'px';
	canvas.style.height = height + 'px';
	canvas.width = width * PIXEL_RATIO; 
	canvas.height = height * PIXEL_RATIO;

	ctx.scale(PIXEL_RATIO, PIXEL_RATIO);

	var img = new Image();
	img.src = "../img/s6_1.png";
	img.onload = function () {  
	    ctx.drawImage(img, 20, 20); 
	}  
}();
</code></pre>

<p>左边是电脑之前模拟的效果，右边是电脑现在模拟的效果：</p>

<p><img src="/images/2015/20150706canvas/1_pc.png" alt="之前电脑" />
<img src="/images/2015/20150706canvas/7_pc.png" alt="之后电脑" /></p>

<p>左边是手机之前的效果，右边是手机现在的效果：</p>

<p><img src="/images/2015/20150706canvas/2_phone.jpg" alt="之前手机" />
<img src="/images/2015/20150706canvas/8_ph.jpg" alt="之后手机" /></p>

<p>嗯，基本的解决方案就是这样。如果有问题，可以提出来～</p>

<p>参考：</p>

<ul>
  <li><a href="http://blog.csdn.net/laijingyao881201/article/details/39505043">http://blog.csdn.net/laijingyao881201/article/details/39505043</a></li>
  <li><a href="http://www.html5rocks.com/en/tutorials/canvas/hidpi/">http://www.html5rocks.com/en/tutorials/canvas/hidpi/</a></li>
</ul>


      <ul class="pager">
        <li class="next"><a href="/archive.html" title="所有文章">查看所有文章 &rarr;</a></li>
      </ul>
     
  </div>

</div>


      </div>

    </div>

    <div id="footer">
      <div class="container">
        <p>&copy; 2015 dcirplan
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </div>
    </div>

    




    <!-- Latest compiled and minified JavaScript, requires jQuery 1.x (2.x not supported in IE8) -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="/assets/themes/bootstrap-3/bootstrap/js/jquery-1.11.2.min.js"></script>
    <script src="/assets/themes/bootstrap-3/bootstrap/js/bootstrap.min.js"></script>
    <script src="/assets/themes/bootstrap-3/bootstrap/lib/prettify/prettify.js"></script>
    <script type="text/javascript">
    $(function () {
        $('pre').addClass('prettyprint');
        prettyPrint();
    });
    </script>
  </body>
</html>

